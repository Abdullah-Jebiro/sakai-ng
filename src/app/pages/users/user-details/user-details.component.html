<p-toast></p-toast>

<ng-container *ngIf="user(); else loadingBlock">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-5">
    <div>
      <h2 class="text-2xl font-bold">{{ user()?.displayName || user()?.identifier }}</h2>
      <p class="text-sm text-surface-500">{{ user()?.identifier }} • أنشئ في {{ user()?.created | date: 'medium' }}</p>
      <p class="text-sm text-surface-500" *ngIf="latest()">آخر جلب: {{ latest()?.timestamp | date: 'medium' }}</p>
    </div>
    <div class="flex flex-wrap gap-2">
      <button pButton icon="pi pi-refresh" label="جلب الآن" (click)="fetchNow()" [loading]="fetching()"></button>
      <button pButton icon="pi pi-download" label="تصدير CSV" (click)="export('csv')"></button>
      <button pButton icon="pi pi-code" label="تصدير JSON" (click)="export('json')" severity="secondary"></button>
      <button pButton icon="pi pi-arrow-right" label="عودة" [routerLink]="['/pages', 'users']" severity="secondary"></button>
    </div>
  </div>

  <div class="grid gap-4 md:grid-cols-3">
    <p-card header="الرصيد الحالي">
      <div class="text-4xl font-bold text-emerald-500" dir="ltr">{{ formatUsage(latest()?.usageGB) }}<span class="text-base ms-2">GB</span></div>
      <p class="mt-2 text-sm text-surface-500">آخر قراءة في {{ latest()?.timestamp | date: 'short' }}</p>
    </p-card>

    <p-card header="الحالة">
      <p-tag [value]="statusLabel()" [severity]="statusSeverity()"></p-tag>
      <p class="mt-3 text-sm" *ngIf="latest()?.errorMessage">رسالة الخطأ: {{ latest()?.errorMessage }}</p>
    </p-card>

    <p-card header="معلومات إضافية">
      <div class="space-y-2 text-sm">
        <div>انتهاء الباقة: {{ latest()?.expiration ? (latest()?.expiration | date: 'mediumDate') : 'غير متوفر' }}</div>
        <div>آخر فاتورة: {{ latest()?.lastInvoice ? (latest()?.lastInvoice | date: 'mediumDate') : 'غير متوفر' }}</div>
        <div>
          الاتصال الحالي: <strong>{{ latest()?.online === true ? 'متصل' : latest()?.online === false ? 'غير متصل' : 'غير معروف' }}</strong>
        </div>
      </div>
    </p-card>
  </div>

  <div class="grid gap-4 lg:grid-cols-2 mt-5">
    <p-card header="اتجاه الاستخدام">
      <p-chart type="line" [data]="chartData()" [options]="chartOptions"></p-chart>
    </p-card>

    <p-card header="تفاصيل الحصة">
      <div class="space-y-2 text-sm">
        <div>حجم الحزمة: {{ formatUsage(latest()?.packageGB) }} GB</div>
        <div>الخدمة الإضافية: {{ formatUsage(latest()?.serviceGB) }} GB</div>
      </div>
    </p-card>
  </div>

  <p-card header="سجل الجلب" class="mt-5">
    <p-table [value]="logs()" [paginator]="true" [rows]="pageSize" [totalRecords]="totalLogs()" [lazy]="true" [loading]="loadingLogs()" (onLazyLoad)="onPage($event)" [first]="(page() - 1) * pageSize" [rowsPerPageOptions]="[10, 20, 50]">
      <ng-template pTemplate="header">
        <tr>
          <th>التاريخ</th>
          <th>الرصيد (GB)</th>
          <th>النجاح</th>
          <th>الحالة</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-row>
        <tr>
          <td>{{ row.timestamp | date: 'medium' }}</td>
          <td dir="ltr">{{ row.usageGB ?? '—' }}</td>
          <td>
            <p-tag [value]="row.success ? 'ناجح' : 'فشل'" [severity]="row.success ? 'success' : 'danger'"></p-tag>
          </td>
          <td>{{ row.errorCategory || '—' }}</td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</ng-container>

<ng-template #loadingBlock>
  <div class="flex items-center justify-center py-10">
    <p-progressSpinner></p-progressSpinner>
  </div>
</ng-template>
